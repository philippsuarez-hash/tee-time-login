<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Back9 Login</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.google.com/recaptcha/api.js?render=6LeUGJYpAAAAAKVJsLS0np45YMtoTtjV-YPle9JE"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--tg-theme-bg-color, #fff);
    color: var(--tg-theme-text-color, #222);
    padding: 20px;
    min-height: 100vh;
  }
  .container { max-width: 400px; margin: 0 auto; }
  h2 { font-size: 20px; margin-bottom: 4px; }
  .subtitle { color: var(--tg-theme-hint-color, #888); font-size: 14px; margin-bottom: 24px; }
  .step { display: none; }
  .step.active { display: block; }
  label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; }
  .phone-row { display: flex; gap: 8px; }
  .country-select {
    width: 90px; flex-shrink: 0;
    padding: 12px 8px; border-radius: 12px;
    border: 1px solid var(--tg-theme-hint-color, #ccc);
    background: var(--tg-theme-secondary-bg-color, #f5f5f5);
    color: var(--tg-theme-text-color, #222);
    font-size: 16px;
  }
  input[type="tel"], input[type="text"] {
    width: 100%; padding: 12px 16px; border-radius: 12px;
    border: 1px solid var(--tg-theme-hint-color, #ccc);
    background: var(--tg-theme-secondary-bg-color, #f5f5f5);
    color: var(--tg-theme-text-color, #222);
    font-size: 18px; outline: none;
  }
  input:focus { border-color: var(--tg-theme-button-color, #3390ec); }
  .btn {
    width: 100%; padding: 14px; border: none; border-radius: 12px;
    background: var(--tg-theme-button-color, #3390ec);
    color: var(--tg-theme-button-text-color, #fff);
    font-size: 16px; font-weight: 600; cursor: pointer;
    margin-top: 16px; transition: opacity 0.2s;
  }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn:active:not(:disabled) { opacity: 0.8; }
  .status { text-align: center; margin-top: 16px; font-size: 14px; color: var(--tg-theme-hint-color, #888); }
  .status.error { color: #e53935; }
  .status.success { color: #43a047; }
  .otp-input {
    text-align: center; letter-spacing: 8px; font-size: 24px; font-weight: 700;
  }
  .terms { font-size: 12px; color: var(--tg-theme-hint-color, #888); margin-top: 12px; line-height: 1.4; }
  .terms a { color: var(--tg-theme-link-color, #3390ec); }
  .done-icon { text-align: center; font-size: 64px; margin: 20px 0; }
  .done-text { text-align: center; font-size: 16px; margin-bottom: 20px; }
</style>
</head>
<body>
<div class="container">

  <!-- Step 1: Phone Number -->
  <div class="step active" id="step-phone">
    <h2>Log in to Back9</h2>
    <p class="subtitle">Enter your phone number to receive an OTP</p>
    <label>Phone number</label>
    <div class="phone-row">
      <select class="country-select" id="country">
        <option value="AE">+971</option>
        <option value="US">+1</option>
        <option value="GB">+44</option>
        <option value="IN">+91</option>
        <option value="DE">+49</option>
        <option value="FR">+33</option>
        <option value="CH">+41</option>
        <option value="AU">+61</option>
      </select>
      <input type="tel" id="phone" placeholder="50 123 4567" inputmode="numeric" autocomplete="tel">
    </div>
    <button class="btn" id="btn-send" onclick="sendOtp()">Send Code</button>
    <div class="status" id="status-phone"></div>
    <p class="terms">By continuing you agree to the Back9 <a href="https://www.back9solutions.com/privacy" target="_blank">Privacy Policy</a> and <a href="https://www.back9solutions.com/terms" target="_blank">Terms</a>.</p>
  </div>

  <!-- Step 2: OTP Verification -->
  <div class="step" id="step-otp">
    <h2>Enter verification code</h2>
    <p class="subtitle" id="otp-subtitle">Code sent to your phone</p>
    <label>5-digit code</label>
    <input type="text" id="otp" class="otp-input" maxlength="5" inputmode="numeric" placeholder="00000" autocomplete="one-time-code">
    <button class="btn" id="btn-verify" onclick="verifyOtp()">Verify</button>
    <div class="status" id="status-otp"></div>
  </div>

  <!-- Step 3: Success -->
  <div class="step" id="step-done">
    <div class="done-icon">&#x2705;</div>
    <div class="done-text"><b>Login successful!</b><br>You can close this window.</div>
  </div>

</div>

<script>
const API = 'https://api.back9solutions.com/api';
const PLATFORM = 'dubaihills';
const RC_KEY = '6LeUGJYpAAAAAKVJsLS0np45YMtoTtjV-YPle9JE';
const DIAL_CODES = { AE:'971', US:'1', GB:'44', IN:'91', DE:'49', FR:'33', CH:'41', AU:'61' };

let storedMobile = '';

const tg = window.Telegram && window.Telegram.WebApp;
if (tg) tg.ready();

function showStep(id) {
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function setStatus(id, msg, cls) {
  const el = document.getElementById(id);
  el.textContent = msg;
  el.className = 'status' + (cls ? ' ' + cls : '');
}

async function getRecaptchaToken() {
  return new Promise((resolve, reject) => {
    grecaptcha.ready(() => {
      grecaptcha.execute(RC_KEY, { action: 'submit' }).then(resolve).catch(reject);
    });
  });
}

async function sendOtp() {
  const phone = document.getElementById('phone').value.replace(/\s/g, '');
  const country = document.getElementById('country').value;
  if (!phone || phone.length < 7) {
    setStatus('status-phone', 'Enter a valid phone number', 'error');
    return;
  }

  const btn = document.getElementById('btn-send');
  btn.disabled = true;
  setStatus('status-phone', 'Generating secure token...');

  try {
    const rcToken = await getRecaptchaToken();
    setStatus('status-phone', 'Sending verification code...');

    const resp = await fetch(API + '/otps/request', {
      method: 'POST',
      headers: {
        'Accept': 'application/vnd.b9api.v1+json',
        'Content-Type': 'application/json',
        'X-Platform-Token': PLATFORM,
        'Authorization': 'Bearer null',
      },
      body: JSON.stringify({
        mobile_country: country,
        mobile_number: parseInt(phone),
        terms: true,
        rc_token: rcToken,
      }),
    });

    const data = await resp.json();
    if (resp.ok) {
      storedMobile = data.data?.mobile || ('+' + DIAL_CODES[country] + phone);
      document.getElementById('otp-subtitle').textContent = 'Code sent to ' + storedMobile;
      showStep('step-otp');
      document.getElementById('otp').focus();
    } else {
      setStatus('status-phone', resp.status + ': ' + (data.message || JSON.stringify(data)), 'error');
    }
  } catch (e) {
    setStatus('status-phone', 'Error: ' + e.message, 'error');
  }
  btn.disabled = false;
}

async function verifyOtp() {
  const otp = document.getElementById('otp').value.trim();
  if (otp.length !== 5) {
    setStatus('status-otp', 'Enter the 5-digit code', 'error');
    return;
  }

  const btn = document.getElementById('btn-verify');
  btn.disabled = true;
  setStatus('status-otp', 'Verifying...');

  try {
    const resp = await fetch(API + '/otps/verify?include=linkedAccounts,vouchers.assets,vouchers.voucherConfig.facility', {
      method: 'POST',
      headers: {
        'Accept': 'application/vnd.b9api.v1+json',
        'Content-Type': 'application/json',
        'X-Platform-Token': PLATFORM,
      },
      body: JSON.stringify({ mobile: storedMobile, otp: otp }),
    });

    const result = await resp.json();
    if (resp.ok) {
      const token = result.meta?.user_token;
      const name = result.data?.name || '';

      if (token) {
        showStep('step-done');
        // Send token back to bot
        if (tg) {
          tg.sendData(JSON.stringify({ token: token, name: name, mobile: storedMobile }));
        }
      } else if (result.meta?.requires_registration || result.meta?.otp_token) {
        setStatus('status-otp', 'Phone not registered with Back9. Sign up at the portal first.', 'error');
      } else {
        setStatus('status-otp', 'Verification failed. No token received.', 'error');
      }
    } else {
      setStatus('status-otp', result.message || 'Invalid code. Try again.', 'error');
    }
  } catch (e) {
    setStatus('status-otp', 'Network error. Try again.', 'error');
  }
  btn.disabled = false;
}

// Auto-advance OTP input when 5 digits entered
document.getElementById('otp').addEventListener('input', (e) => {
  if (e.target.value.length === 5) verifyOtp();
});

// Enter key handlers
document.getElementById('phone').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') sendOtp();
});
</script>
</body>
</html>
